#!/system/bin/busybox sh

TLS_OVER_DNS="1.1.1.1"

VPN_CONFIG_DIR="/online/openvpn"
VPN_DNS_OVER_TLS="$VPN_CONFIG_DIR/dot"
DNS_REDIR="/system/bin/openvpn_scripts/dns-redir.sh"

PATH=/bin:/sbin:/app/bin:/system/sbin:/system/bin:/system/xbin

if [[ $(cat "$VPN_DNS_OVER_TLS") -eq 1 ]]; then
  $DNS_REDIR 0 >/dev/null 2>&1
  sleep 2
  $DNS_REDIR $TLS_OVER_DNS >/dev/null 2>&1
fi

# Add MASQUERADE to tun/tap interfaces
xtables-multi iptables -t nat -I POSTROUTING -o tun+ -j MASQUERADE
xtables-multi iptables -t nat -I POSTROUTING -o tap+ -j MASQUERADE

# Add DROP rule to FORWARD chain (disallow forwarding FROM VPN TO LAN)
xtables-multi iptables -A FIREWALL_FORWARD -i tun+ -j DROP
xtables-multi iptables -A FIREWALL_FORWARD -i tap+ -j DROP

# Add DROP rule to INPUT chain (disallow access FROM VPN TO ROUTER SERVICES)
xtables-multi iptables -A FIREWALL_INPUT -i tun+ -j DROP
xtables-multi iptables -A FIREWALL_INPUT -i tap+ -j DROP

exit 0
